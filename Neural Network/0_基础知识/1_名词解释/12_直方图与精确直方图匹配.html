<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diary</title>
    <link rel="stylesheet" href="/Template/styles.css">
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <div class="container">
        &ensp;&ensp;在阅读文章《Exact Feature Distribution Matching for Arbitrary Style Transfer and Domain Generalization》时, 发现了精确直方图匹配, 故在此学习并记录.<br>
        同时, 该文章中还提到了 “经验累计分布函数”. 该概念我记录在了 三星平板上, 如果需要复习请移步查看.
        
        首先需要介绍直方图. 用一句话介绍直方图, 就是随机变量的值落进区间内的数量.
        <h1>直方图</h1>
        什么是直方图？就是对某个统计对象, 统计其某项属性出现的次数. 如统计图像中的像素, 其灰度在0、1、2……255出现的次数.
        绘制直方图有几个关键点:
        <ol>
            <li>确定你需要统计的对象, 如以图像中每个像素作为统计对象.</li>
            <li>确定你需要统计的量, 并将其作为横坐标. 直方图的纵坐标是不带单位的, 仅用做计数的, 也即频数.</li>
            <li>将该横坐标分割为多个连续区间, 如 10~20, 20~30, 30~40等.</li>
        </ol>
        &ensp;&ensp;确定了这两个信息后, 就可以绘制出任意直方图了. 下面我们举几个例子介绍一下, 从我们最熟悉的熟悉图像处理开始.<br>
        &ensp;&ensp;首先我们需要确定统计什么量, 也即确定直方图的横坐标. 假设我们现在需要统计的是当前图像的灰度信息, 那么我们就将灰度值当做横坐标, 以图像中每个像素作为统计对象(随机变量). 其次我们将该横坐标分成多个不重叠且连续的区间, 如 0~10, 10~20, ……, 240~250, 250~255. 这些区间可以是不等距的. 在确定完横坐标与横坐标的分区后, 我们统计图像中每个像素的灰度值, 当灰度值落入某个区间时, 该区间的频数(纵坐标)加一, 直到处理完每个像素. 这样我们就得到了一张有关输入图像灰度值的直方图.<br>
        &ensp;&ensp;下面是“以一张图像灰度值作为横坐标”, “区间长度为1”为基础设定生成的灰度值直方图.<br>
        <img src="https://raw.githubusercontent.com/Nekasu/Blog_pics/main/grayscale_with_hist.jpg"/>
        当然, 我们还可以以图像的r、g、b通道分别作为横坐标, 生成颜色直方图, 如下图所示:
        <img src="https://raw.githubusercontent.com/Nekasu/Blog_pics/main/combined_output.jpg"/>

        <h1>直方图均衡化</h1>
        &ensp;&ensp;直方图均衡化是直方图匹配的前置知识, 而直方图匹配又是精确直方图匹配的前置知识, 所以这里率先介绍直方图均衡化. <br>
        &ensp;&ensp;<span class="color-huohuo-green">首先介绍直方图均衡化的必要性</span>，这里我们以一张图像灰度值的直方图作为例子进行讲解。若一张图像的灰度值主要集中在较窄的区间内（例如集中于较暗或较亮的区域），则该图像整体对比度较低，细节表现不清晰，难以满足人眼观察或后续图像分析任务的需求。此时，图像在直方图中表现为灰度分布集中，未能有效利用整个灰度空间。如下图所示.
        <img src="https://raw.githubusercontent.com/Nekasu/Blog_pics/main/202506271104k9.png"/>

        &ensp;&ensp;通过直方图均衡化，可以将原本集中的灰度值重新分布到更广泛的灰度范围内，使得图像的亮度层次更加丰富，增强边缘与纹理等细节的可见性。在直方图中，均衡化后的结果通常呈现出更为平坦和均匀的分布，表明图像的整体动态范围得到了扩展。因此，直方图均衡化是一种简单而有效的图像增强方法，特别适用于对比度不足的图像场景。以下是直方图均衡化后的结果.
        <img src="https://raw.githubusercontent.com/Nekasu/Blog_pics/main/20250627111300.png"/>
        
        &ensp;&ensp;下面我们开始理论推导这个变化过程. 这里我们依旧使用图像的灰度值作为例子进行探讨. 当然, 可以直方图均衡化不仅仅限制于灰度值, 只要你能给出某个变量(某个研究对象)的直方图, 那么就能对该变量进行直方图均衡化. 为了使变化过程更加明了, 我们首先定义一些变量. 
        <ul>
            <li>
                原始像素的灰度值: \(r\). 在进行直方图均衡化的时候, 我们是对原始图像中每个像素点进行灰度值的变化的, 该值\(r\)即为原始像素的灰度值.
            </li>
            <li>
                目标像素的灰度值: \(s\). 在对某个图像进行灰度值的直方图均衡化后, 其中某个像素点的灰度值.
            </li>
            <li>
                图像的灰度阶数: \(L-1\). 对一个256个灰度阶的图像而言, 即为 256-1=255(从0开始计数).
            </li>
            <!-- <li>
                原始图像的灰度直方图: \(f_R(r)\). 一般来说, 某个图像归一化后的的灰度直方图, 就近似于该图像灰度值的“经验概率密度函数”, 所以也会记作 \(ePDF_R(r)\)
            </li>
            <li>
                目标图像的灰度直方图: \(f_S(s)\). 一般来说, 某个图像归一化后的的灰度直方图, 就近似于该图像灰度值的“经验概率密度函数”, 所以也会记作 \(ePDF_S(s)\)
            </li> -->
        </ul>
        我们希望, 经过某种变换后, 原始图像中像素的灰度值 \(r\) 能变成另一个 目标图像中像素的灰度值 
        \(s\). 也即存在这种变换 \(s=T(r\), 将灰度值 \(r\) 变为 灰度值 \(s\).
        在变换完毕后, 目标图像中灰度值的概率分布服从均匀分布, 也即 \(PDF_S(s) \sim Uniform(L-1)\), 每一个灰度阶出现的概率都是相同的 \(\frac{1}{L-1}\), 所以有
        $$PDF_S(s)=\frac{1}{L-1}\quad\cdots\cdots \text{式}1$$
        因为我们最终需要得到的是变换 \(T\), 为了解出该变换, 我们需要考虑其他已知条件.
        
        同时, 我们还知道随机变量 \(R\) 与随机变量 \(S\)之间满足如下关系:
        $$S=T(R)$$
        也即
        $$R=T^{-1}(S)$$
        所以我们可以得到如下推导:
        $$  \begin{equation} \begin{aligned}CDF_S(s)&=P\{S\le s\}\\ &=P\{T(R)\le s\}\\ &=P\{R\le T^{-1}(s)\}\\ &= CDP_R(T^{-1}(s)) \end{aligned}\end{equation} 
        $$
        若无法理解该过程, 可以参考下图辅助理解:
        <img src="https://raw.githubusercontent.com/Nekasu/Blog_pics/main/20250627145321.png"/>
        通过上式, 我们得到了随机变量 \(S\) 服从的概率累计分布函数\(CDF_S\), 进而可以通过求导得到随机变量 \(S\) 服从的概率密度函数 \(PDF_S\), 过程如下:
        $$
        \begin{equation}
        \begin{aligned}
        PDF_S(s) &= \left( CDF_R(T^{-1}(s))\right)'\\
        &=  CDF_R'(T^{-1}(s)) \cdot \frac{\text{d}T^{-1}(s)}{\text{d}} \quad \quad \text{用}r=T^{-1}(s)代替 T^{-1}(s)\\
        &= PDF_R(r) \cdot \frac{\text{d}r}{\text{d}s}\bigg\vert_{r=T^{-1}(s)} \cdots \cdots \text{式}2
        \end{aligned}
        \end{equation}
        $$
        得到 \(PDF_S\)后, 即可以上式\(1\) 联立并进一步化简如下:
        $$
        \begin{equation}
        \begin{aligned}
        PDF_S = \frac{1}{l-1} &= PDF_R(r) \cdot \frac{\text{d}r}{\text{d}s}\\
        \frac{1}{L-1} \text{d}s &= PDF_R(r) \cdot \text{d}r\\
        \int \frac{1}{L-1} \text{d}s &= \int PDF_R(r) \cdot \text{d}r\\
        \frac{1}{L-1} \cdot s &= CDF_R(r)\\
        s &= (L-1) \cdot CDF_R(r)
        \end{aligned}
        \end{equation}
        $$
        而 \(s=T(r)\) 也就是 \( s = (L-1) \cdot CDF_R(r) \), 这样我们就得到了 直方图均衡化的变换公式: 
        $$T(r) = (L-1) \cdot CDF_R(r) $$
        其中 \(CDF_R(r)\) 一般用原图像的直方图计算得来. 原图像的直方图为 \(ePDF_R(r)\).
          <h1>直方图匹配</h1>

          <h2>1. 问题定义</h2>
          <p>直方图匹配的目标是将原始图像 \(R\) 的灰度分布，通过某种变换映射为目标图像 \(Z\) 的灰度分布。</p>

          <h2>2. 基本思路</h2>
          <ol>
            <li>将 \(R\) 通过直方图均衡化映射为中间变量 \(S\)；</li>
            <li>将 \(Z\) 也进行直方图均衡化，得到变换函数 \(T_Z(z)\)；</li>
            <li>构建逆变换 \(T_Z^{-1}(s)\)，令最终变换为：\( z = T_Z^{-1}(T_R(r)) \)<br>
            </li>
          </ol>

          <h2>3. 理论推导</h2>
          对原始图像 \(R\) 有：
          $$s = T_R(r) = (L-1) \cdot CDF_R(r)$$

          对目标图像 \(Z\) 有：
          $$s = T_Z(z) = (L-1) \cdot CDF_Z(z)$$
          因此逆变换为：
          $$z = T_Z^{-1}(s) = CDF_Z^{-1}(s / (L-1))$$

          最终得到匹配函数：
          $$M(r) = T_Z^{-1}(T_R(r))$$

          <h2>4. 实际操作（查表法）</h2>
          由于实际图像灰度是离散的，\(T_Z\) 通常无解析形式，因此 <strong>逆均衡化过程</strong>往往通过查找表实现：
          <ul>
            <li>计算目标图像的累积分布 \(CDF_Z\)；</li>
            <li>对每一个中间值 \(s\)，查找使 \(T_Z(z) \sim s\) 的 \(z\)；</li>
            <li>构造查找表 \(inverse\_map[s] = z\)。</li>
          </ul>


          <h2>5. 小结</h2>
          <ul>
            <li>理论上，若 \(T_Z\) 可导且可逆，可写出完整数学表达式；</li>
            <li>但由于实际图像中灰度分布为经验统计，故常以查表近似；</li>
            <li>最终变换为 \(z = T_Z^{-1}(T_R(r))\)。</li>
          </ul>
        <h1>精确直方图匹配（Exact Histogram Matching）</h1>

          <h2>一、基本概念</h2>
          <p>精确直方图匹配（EHM）是一种像素级操作方法，其目标是将一张图像的灰度（或颜色）分布<strong>精确匹配</strong>到另一张图像的分布。这一方法完全基于<strong>像素排序与重新赋值</strong>，几乎<strong>不依赖传统概率论中的概率密度函数（PDF）或累积分布函数（CDF）</strong>。</p>
          <p>因此，EHM 是一种<strong>非概率建模导向</strong>的统计分布匹配方法，在离散图像中尤为实用。</p>

          <h2>二、方法流程</h2>
          <ol>
            <li>将原图像像素灰度值拉平成一维向量并升序排序。</li>
            <li>将目标图像像素灰度值也拉平排序，构成目标排序灰度。</li>
            <li>将原图排序第 <code>i</code> 个像素赋值为目标图排序第 <code>i</code> 个灰度值。</li>
            <li>按原图索引重构图像。</li>
          </ol>

          <h2>三、数学表达</h2>
          <p>设原图像灰度值集合为：</p>
          $$
            R = { r₁, r₂, ..., rₙ }
          $$
          <p>目标图像灰度值集合为：</p>
          $$
            Z = { z₁, z₂, ..., zₙ }
          $$
          <p>对两组灰度进行升序排序：</p>
          $$
          \begin{equation}
          \begin{aligned}
          r_{π(1)} ≤ r_{π(2)} ≤ ... ≤ r_{π(n)}\\
          z_{\sigma (1)} ≤ z_{\sigma (2)} ≤ ... ≤ z_{\sigma (n)}
          \end{aligned}
          \end{equation}
          $$
          <p>映射关系为：</p>
          $$
            r_{π(i)} → z_{\sigma (i)}， ∀ i ∈ {1,...,n}
          $$

          <h2>四、避免排序偏差：处理相同灰度像素</h2>
          <p>当原始图像中存在大量相同灰度值的像素时，直接按像素索引顺序排序可能导致空间结构偏差。典型问题如：图像上半部分被分配较暗灰度，而下半部分被分配较亮灰度，从而造成结构割裂。</p>

          <p>为解决这一问题，可使用如下策略：</p>
          <ol>
            <li>
                随机打乱同灰度像素索引<br>
                &ensp;&ensp;对于每个灰度值相同的像素集合，在排序后<strong>随机打散</strong>其索引，从而实现平衡的灰度分配，避免结构偏置。
            </li>
            <li>
                局部区域精确匹配<br>
                &ensp;&ensp;将图像划分为区域块，在每块内进行局部精确匹配，有助于保持区域一致性。
            </li>
            <li>
                结构引导排序<br>
                &ensp;&ensp;可按图像梯度、位置权重或语义信息辅助排序，增强结构保留能力。
            </li>
          </ol>
          <h2>六、对比：传统 vs 精确直方图匹配</h2>
          <table id="table-blue">
            <thead>
              <tr>
                <th>项目</th>
                <th>传统直方图匹配</th>
                <th>精确直方图匹配</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>依赖概率建模</td>
                <td>是（CDF/PDF）</td>
                <td><strong>否</strong></td>
              </tr>
              <tr>
                <td>理论基础</td>
                <td>概率密度函数映射</td>
                <td>排序 + 索引重排</td>
              </tr>
              <tr>
                <td>匹配精度</td>
                <td>近似</td>
                <td>逐像素精确</td>
              </tr>
              <tr>
                <td>可逆性</td>
                <td>不可逆</td>
                <td>理论可逆</td>
              </tr>
              <tr>
                <td>结构保持性</td>
                <td>较强</td>
                <td>需额外设计</td>
              </tr>
            </tbody>
          </table>

          <h2>七、总结</h2>
          <p>精确直方图匹配是一种<strong>不依赖概率密度或函数推导</strong>的分布对齐方法，其核心在于像素排序与重新赋值，适用于图像风格迁移、医学图像标准化与其他需要分布一致性而非结构保持的场景。</p>
          <p>实际应用中需特别注意相同灰度值像素的处理策略，以避免空间偏差。</p>
    </div>
</body>
</html>